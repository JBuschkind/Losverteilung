<!doctype html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Juleklapp â€“ Master</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <main class="container">
      <h1>Juleklapp â€“ Master</h1>

      <section>
        <div class="toolbar">
          <button id="draw-btn" class="primary">LOS!</button>
          <span id="hint">Starte erst, wenn alle beigetreten sind.</span>
        </div>
      </section>

      <section>
        <h2>Teilnehmer</h2>
        <ul id="list" class="list"></ul>
      </section>

      <div id="msg" class="msg"></div>
    </main>

    <script>
      const list = document.getElementById('list');
      const drawBtn = document.getElementById('draw-btn');
      const msg = document.getElementById('msg');

      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      const ws = new WebSocket(`${proto}://${location.host}/?role=master`);

      function render(participantsData) {
        list.innerHTML = '';
        const participants = participantsData || [];
        participants.forEach((p) => {
          const li = document.createElement('li');
          li.className = 'list-item';
          
          const infoDiv = document.createElement('div');
          infoDiv.style.display = 'flex';
          infoDiv.style.flexDirection = 'column';
          infoDiv.style.gap = '4px';
          
          const nameSpan = document.createElement('span');
          nameSpan.textContent = p.name || p;
          nameSpan.style.fontWeight = 'bold';
          
          const emailSpan = document.createElement('span');
          emailSpan.textContent = typeof p === 'object' ? p.email : '';
          emailSpan.style.fontSize = '0.9em';
          emailSpan.style.color = '#666';
          
          const statusSpan = document.createElement('span');
          if (typeof p === 'object') {
            statusSpan.textContent = p.online ? 'ðŸŸ¢ Online' : 'âš« Offline';
            statusSpan.style.fontSize = '0.85em';
            statusSpan.style.color = p.online ? '#4CAF50' : '#999';
          }
          
          infoDiv.appendChild(nameSpan);
          if (typeof p === 'object' && p.email) {
            infoDiv.appendChild(emailSpan);
          }
          if (typeof p === 'object') {
            infoDiv.appendChild(statusSpan);
          }
          
          const btn = document.createElement('button');
          btn.textContent = 'Entfernen';
          btn.addEventListener('click', () => {
            ws.send(JSON.stringify({ type: 'remove_name', name: p.name || p }));
          });
          
          li.appendChild(infoDiv);
          li.appendChild(btn);
          list.appendChild(li);
        });
        drawBtn.disabled = participants.length < 2;
      }

      ws.addEventListener('message', (ev) => {
        const data = JSON.parse(ev.data);
        if (data.type === 'participants') {
          // Use participantsWithEmail if available, otherwise fall back to participants array
          const participantsData = data.participantsWithEmail || data.participants || [];
          render(participantsData);
        }
        if (data.type === 'error') {
          msg.textContent = data.message || 'Fehler';
          setTimeout(() => (msg.textContent = ''), 3000);
        }
        if (data.type === 'draw_complete') {
          msg.textContent = 'Auslosung abgeschlossen!';
          setTimeout(() => (msg.textContent = ''), 5000);
        }
      });

      drawBtn.addEventListener('click', () => {
        ws.send(JSON.stringify({ type: 'start_draw' }));
      });
    </script>
  </body>
  </html>



